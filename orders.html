<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shot.Cut — Orders</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #060607;
        --muted: #cfcfd0;
        --accent: #00ffc6;
        --card: rgba(255, 255, 255, 0.03);
      }
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: linear-gradient(180deg, #040405 0%, #0b0b0b 100%);
        color: #fff;
        padding: 28px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 18px;
      }
      .brand {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .brand img {
        width: 44px;
        height: 44px;
        border-radius: 8px;
      }
      h1 {
        color: var(--accent);
        font-size: 20px;
        margin: 0;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn {
        padding: 10px 14px;
        border-radius: 10px;
        border: 0;
        cursor: pointer;
        font-weight: 700;
        background: linear-gradient(90deg, #00ffc6, #39f2d1);
        color: #041414;
      }
      .btn.ghost {
        background: transparent;
        color: var(--muted);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .orders {
        display: flex;
        flex-direction: column;
        gap: 14px;
        margin-top: 16px;
      }
      .order {
        width: 100%;
        border-radius: 12px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        padding: 18px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        display: flex;
        flex-direction: row;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
      }
      .order-left {
        flex: 1;
      }
      .meta {
        color: #bfbfbf;
        font-size: 13px;
        margin-bottom: 8px;
      }
      .title {
        color: var(--accent);
        font-weight: 800;
        margin-bottom: 6px;
      }
      .order-right {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .contact-btn {
        padding: 10px 12px;
        border-radius: 10px;
        border: 0;
        cursor: pointer;
        background: linear-gradient(90deg, #00d18e, #00ffc6);
        color: #041414;
        font-weight: 800;
      }
      .ghost-small {
        background: transparent;
        color: var(--muted);
        border: 1px solid rgba(255, 255, 255, 0.06);
        padding: 8px 10px;
        border-radius: 8px;
      }
      .trash {
        background: linear-gradient(90deg, #ff6b6b, #ff9b6b);
        color: #041414;
        border-radius: 10px;
        border: 0;
        padding: 10px 12px;
        font-weight: 800;
        cursor: pointer;
      }
      .empty {
        color: #bfbfbf;
        padding: 28px;
        border-radius: 12px;
        text-align: center;
        border: 1px dashed rgba(255, 255, 255, 0.04);
      }
      @media (max-width: 720px) {
        .order {
          flex-direction: column;
          align-items: flex-start;
        }
        .order-right {
          width: 100%;
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="brand">
        <img src="https://i.ibb.co/KxYv46dg/ScLogo2.png" alt="logo" />
        <div>
          <h1>Shot.Cut — Orders</h1>
          <div style="color: #bfbfbf; font-size: 13px">
            Private orders dashboard
          </div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn ghost" id="exportBtn">Export JSON</button>
        <button class="btn ghost" id="clearAllBtn">Delete all</button>
      </div>
    </div>

    <div id="ordersWrap">
      <div class="empty">Loading orders...</div>
    </div>

    <!-- Firebase Firestore + Auth + Orders Management -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        updateDoc,
        doc,
        addDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      /* ======================= FIREBASE SETUP ======================= */
      const firebaseConfig = {
        apiKey: "AIzaSyDz2AihRzh2YyA7AGJGnXJv32YfkizlOEs",
        authDomain: "shotcut-orders.firebaseapp.com",
        projectId: "shotcut-orders",
        storageBucket: "shotcut-orders.firebasestorage.app",
        messagingSenderId: "870361471367",
        appId: "1:870361471367:web:30fbe46a05365374231b22",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth();
      window.db = db;

      /* ======================= SIMPLE ADMIN LOGIN ======================= */
      const ADMIN_EMAIL = "shot.cut143@gmail.com"; // <- Replace with your Firebase admin email

      async function requireAdminSignIn() {
        // This is the prompt-based sign-in flow you used before (keeps behavior same)
        const currentUser = auth.currentUser;
        if (currentUser && currentUser.email === ADMIN_EMAIL) {
          console.log("✅ Already signed in as admin:", currentUser.email);
          return;
        }

        for (let attempt = 0; attempt < 3; attempt++) {
          const email = prompt("Enter admin email:");
          const password = prompt("Enter password:");
          if (!email || !password) break;
          try {
            const res = await signInWithEmailAndPassword(auth, email, password);
            if (res.user && res.user.email === ADMIN_EMAIL) {
              console.log("✅ Signed in as admin:", res.user.email);
              return;
            } else {
              await signOut(auth);
              alert("This account is not authorized as admin. Try again.");
            }
          } catch (err) {
            alert("Sign-in failed: " + (err.message || err.code));
          }
        }

        document.body.innerHTML =
          "<div style='padding:40px;text-align:center;color:#f88'>Access denied. Please sign in as admin to view orders.</div>";
        throw new Error("Access denied - not authenticated as admin");
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("Auth state changed — signed in:", user.email);
        } else {
          console.log("Auth state changed — signed out");
        }
      });

      /* ======================= ORDERS MANAGEMENT ======================= */
      const wrap = document.getElementById("ordersWrap");
      const refreshBtn = document.getElementById("refreshBtn");
      const exportBtn = document.getElementById("exportBtn");
      const clearAllBtn = document.getElementById("clearAllBtn");

      async function loadOrders() {
        const snap = await getDocs(collection(window.db, "orders"));
        const orders = [];
        snap.forEach((d) => {
          const data = d.data();
          if (!data.deleted) orders.push({ id: d.id, ...data }); // skip deleted
        });
        render(orders);
      }

      function formatCreatedAt(ts) {
        if (!ts) return "<em>—</em>";
        // Firestore Timestamp object (has toDate)
        if (typeof ts === "object" && typeof ts.toDate === "function") {
          return ts.toDate().toLocaleString();
        }
        // ISO string or number
        try {
          const d = new Date(ts);
          if (!isNaN(d.getTime())) return d.toLocaleString();
        } catch (e) {}
        return "<em>Invalid Date</em>";
      }

      function render(arr) {
        wrap.innerHTML = "";
        if (!arr || arr.length === 0) {
          wrap.innerHTML = '<div class="empty">No orders yet.</div>';
          return;
        }
        const container = document.createElement("div");
        container.className = "orders";

        arr.forEach((o) => {
          const card = document.createElement("div");
          card.className = "order";

          const left = document.createElement("div");
          left.className = "order-left";

          // Cost label
          let costLabel = o.costLabel;
          if (!costLabel) {
            const symbol =
              o.currency === "INR" ? "₹" : o.currency === "EUR" ? "€" : "$";
            costLabel = `${symbol}${o.cost}`;
          }

          const statusLabel =
            o.status === "approved"
              ? '<span style="color:#00ffb0; font-weight:800">Approved</span>'
              : '<span style="color:#f0bfbf; font-weight:800">New</span>';

          left.innerHTML = `
  <div style="display:flex; align-items:center; gap:10px; justify-content:space-between">
    <div class="title">${escapeHtml(o.productType || "")} • ${escapeHtml(
            o.quality || ""
          )} • ${escapeHtml(costLabel)}</div>
    <div>${statusLabel}</div>
  </div>
  <div class="meta">Order ID: ${escapeHtml(o.id)} • ${formatCreatedAt(
            o.createdAt
          )}</div>
  <div style="color:#e6e6e6; margin-bottom:8px"><strong>Topic</strong>: ${
    o.title ? escapeHtml(o.title) : "<em>—</em>"
  }</div>
  <div style="color:#bfbfbf; font-size:13px"><strong>Description</strong>: ${
    o.description ? escapeHtml(o.description) : "<em>—</em>"
  }</div>
  <div style="color:#bfbfbf; font-size:13px; margin-top:8px"><strong>Instagram</strong>: ${
    o.instagram
      ? `<a href="https://instagram.com/${encodeURIComponent(
          o.instagram.replace(/^@/, "")
        )}" target="_blank" rel="noopener" class="ghost-small">${escapeHtml(
          o.instagram
        )}</a>`
      : "<em>—</em>"
  }</div>
  <div style="color:#bfbfbf; font-size:13px; margin-top:6px"><strong>Email</strong>: ${
    o.email ? escapeHtml(o.email) : "<em>—</em>"
  }</div>
  <div style="color:#bfbfbf; font-size:13px; margin-top:6px"><strong>Phone</strong>: ${
    o.phone ? escapeHtml(o.phone) : "<em>—</em>"
  }</div>
`;

          const right = document.createElement("div");
          right.className = "order-right";

          // Contact (tel)
          const contact = document.createElement("a");
          contact.className = "contact-btn";
          const phoneNormalized = (o.phone || "").replace(/\s+/g, "");
          contact.href = `tel:${phoneNormalized}`;
          contact.textContent = `Contact ${o.phone || ""}`;
          contact.setAttribute("aria-label", "Contact client");

          // WhatsApp
          const waContainer = document.createElement("div");
          if (o.whatsapp && o.whatsapp.trim() !== "") {
            const waButton = document.createElement("a");
            waButton.className = "btn ghost";
            const waNum = o.whatsapp.replace(/\D/g, "");
            const msg = encodeURIComponent(
              `Hi, regarding order ${o.id} — ${o.productType}, ${o.quality}.`
            );
            waButton.href = `https://wa.me/${waNum}?text=${msg}`;
            waButton.target = "_blank";
            waButton.textContent = "WhatsApp";
            waContainer.appendChild(waButton);
          } else {
            const notProvided = document.createElement("div");
            notProvided.style.color = "#bfbfbf";
            notProvided.style.padding = "8px 10px";
            notProvided.style.borderRadius = "8px";
            notProvided.style.fontWeight = "700";
            notProvided.textContent = "WhatsApp: Not Provided";
            waContainer.appendChild(notProvided);
          }

          // Approve button
          const approveBtn = document.createElement("button");
          approveBtn.className = "btn";
          approveBtn.textContent =
            o.status === "approved" ? "Approved" : "Approve";
          approveBtn.disabled = o.status === "approved";
          approveBtn.title = "Approve order and notify client by email";
          approveBtn.style.fontWeight = "800";
          approveBtn.addEventListener("click", async () => {
            if (
              !confirm("Approve this order and send approval email to client?")
            )
              return;

            // Update Firestore status
            try {
              const orderRef = doc(window.db, "orders", o.id);
              await updateDoc(orderRef, { status: "approved" });
              alert("Order approved and updated in database!");
              await loadOrders();
            } catch (e) {
              console.error("Error updating Firestore order:", e);
              alert("Failed to update order in Firestore.");
              return;
            }

            // Send Email via EmailJS
            try {
              const SERVICE_ID = "service_2t9misj";
              const TEMPLATE_ID = "template_5dtjlro";
              const templateParams = {
                to_email: o.email || "",
                order_id: o.id,
                product_type: o.productType,
                quality: o.quality,
                cost_label: o.costLabel || o.cost,
                topic: o.topic || "",
                phone: o.phone || "",
              };
              if (!window.emailjs) {
                console.warn("EmailJS not initialized yet.");
                return;
              }
              await emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
              alert("Approval email sent to client.");
            } catch (err) {
              console.error("Error sending approval email:", err);
              alert(
                "Failed to send approval email. Check console for details."
              );
            }
          });

          // Delete button
          const del = document.createElement("button");
          del.className = "trash";
          del.textContent = "Delete";
          del.addEventListener("click", async () => {
            if (!confirm("Are you sure you want to delete this order?")) return;
            try {
              const orderRef = doc(window.db, "orders", o.id);
              await updateDoc(orderRef, { deleted: true });
              alert("Order deleted successfully.");
              card.remove(); // instantly remove from DOM
            } catch (e) {
              console.error("Error deleting order:", e);
              alert("Failed to delete order.");
            }
          });

          right.appendChild(contact);
          right.appendChild(waContainer);
          right.appendChild(approveBtn);
          right.appendChild(del);

          card.appendChild(left);
          card.appendChild(right);
          container.appendChild(card);
        });

        wrap.appendChild(container);
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      refreshBtn.addEventListener("click", loadOrders);
      exportBtn.addEventListener("click", () => {
        // keep behavior similar to your earlier code; adjust if you want to export real data
        const dataStr =
          "data:text/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify([], null, 2));
        const a = document.createElement("a");
        a.href = dataStr;
        a.download = "shotcut_orders.json";
        a.click();
      });
      clearAllBtn.addEventListener("click", () => {
        alert("You cannot clear all orders directly.");
      });

      /* ======================= EMAILJS INITIALIZATION (v4) ======================= */
      (function () {
        const script = document.createElement("script");
        script.src =
          "https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js";
        script.onload = () => {
          emailjs.init({ publicKey: "6AjRFYI2o58UTimZ3" }); // replace with your public key if different
          console.log("✅ EmailJS v4 initialized");
        };
        document.head.appendChild(script);
      })();

      /* ======================= INITIALIZATION FLOW ======================= */
      (async () => {
        try {
          await requireAdminSignIn(); // now defined above
          await loadOrders();
        } catch (err) {
          console.log("Admin not authenticated, stopping load.", err);
        }
      })();
    </script>
  </body>
</html>
